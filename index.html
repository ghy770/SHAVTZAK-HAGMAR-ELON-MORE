// קוד Google Apps Script שצריך להעתיק לעורך של Google

function doPost(e) {
  const lock = LockService.getScriptLock();
  
  try {
    lock.waitLock(10000);
    
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    switch(action) {
      case 'saveUsers':
        return saveUsers(data.users);
      case 'loadUsers':
        return loadUsers();
      case 'saveSchedule':
        return saveSchedule(data.schedule);
      case 'loadSchedule':
        return loadSchedule();
      case 'saveAvailability':
        return saveAvailability(data.availability);
      case 'loadAvailability':
        return loadAvailability();
      case 'saveSettings':
        return saveSettings(data.settings);
      case 'loadSettings':
        return loadSettings();
      default:
        return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}));
    }
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({error: error.toString()}));
  } finally {
    lock.releaseLock();
  }
}

function doGet(e) {
  const action = e.parameter.action;
  
  switch(action) {
    case 'loadUsers':
      return loadUsers();
    case 'loadSchedule':
      return loadSchedule();
    case 'loadAvailability':
      return loadAvailability();
    case 'loadSettings':
      return loadSettings();
    default:
      return ContentService.createTextOutput(JSON.stringify({error: 'Invalid action'}));
  }
}

// פונקציות עזר
function saveUsers(users) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  
  // נקה את הגיליון
  sheet.clear();
  
  // כותרות
  sheet.getRange(1, 1, 1, 6).setValues([['ID', 'First Name', 'Last Name', 'Phone', 'Type', 'Password']]);
  
  // נתונים
  if (users && users.length > 0) {
    const data = users.map(user => [
      user.id,
      user.firstName,
      user.lastName,
      user.phone,
      user.type,
      user.password || ''
    ]);
    
    sheet.getRange(2, 1, data.length, 6).setValues(data);
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function loadUsers() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Users');
  const data = sheet.getDataRange().getValues();
  
  if (data.length <= 1) {
    // החזר רק את המנהל הכללי אם אין נתונים
    const defaultUsers = [{
      id: 1,
      firstName: 'מנהל',
      lastName: 'כללי',
      phone: '0585123770',
      type: 'admin'
    }];
    return ContentService.createTextOutput(JSON.stringify({users: defaultUsers}));
  }
  
  const users = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) { // אם יש ID
      users.push({
        id: data[i][0],
        firstName: data[i][1],
        lastName: data[i][2],
        phone: data[i][3],
        type: data[i][4],
        password: data[i][5] || ''
      });
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({users: users}));
}

function saveSchedule(schedule) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Schedule');
  
  // נקה את הגיליון
  sheet.clear();
  
  // כותרות
  sheet.getRange(1, 1, 1, 2).setValues([['Cell ID', 'Assigned']]);
  
  // נתונים
  const entries = Object.entries(schedule);
  if (entries.length > 0) {
    const data = entries.map(([cellId, assigned]) => [cellId, assigned]);
    sheet.getRange(2, 1, data.length, 2).setValues(data);
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function loadSchedule() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Schedule');
  const data = sheet.getDataRange().getValues();
  
  const schedule = {};
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) { // אם יש Cell ID
      schedule[data[i][0]] = data[i][1];
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({schedule: schedule}));
}

function saveAvailability(availability) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Availability');
  
  // נקה את הגיליון
  sheet.clear();
  
  // כותרות
  sheet.getRange(1, 1, 1, 4).setValues([['User ID', 'Unavailable Shifts', 'Submitted', 'Submitted At']]);
  
  // נתונים
  const entries = Object.entries(availability);
  if (entries.length > 0) {
    const data = entries.map(([userId, userAvailability]) => [
      userId,
      userAvailability.unavailableShifts ? Array.from(userAvailability.unavailableShifts).join(',') : '',
      userAvailability.submitted || false,
      userAvailability.submittedAt || ''
    ]);
    
    sheet.getRange(2, 1, data.length, 4).setValues(data);
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function loadAvailability() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Availability');
  const data = sheet.getDataRange().getValues();
  
  const availability = {};
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) { // אם יש User ID
      availability[data[i][0]] = {
        unavailableShifts: new Set(data[i][1] ? data[i][1].split(',') : []),
        submitted: data[i][2] || false,
        submittedAt: data[i][3] || ''
      };
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({availability: availability}));
}

function saveSettings(settings) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings');
  
  // נקה את הגיליון
  sheet.clear();
  
  // כותרות
  sheet.getRange(1, 1, 1, 2).setValues([['Setting', 'Value']]);
  
  // נתונים
  const entries = Object.entries(settings);
  if (entries.length > 0) {
    const data = entries.map(([key, value]) => [key, JSON.stringify(value)]);
    sheet.getRange(2, 1, data.length, 2).setValues(data);
  }
  
  return ContentService.createTextOutput(JSON.stringify({success: true}));
}

function loadSettings() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings');
  const data = sheet.getDataRange().getValues();
  
  const settings = {};
  for (let i = 1; i < data.length; i++) {
    if (data[i][0]) { // אם יש Setting
      try {
        settings[data[i][0]] = JSON.parse(data[i][1]);
      } catch (e) {
        settings[data[i][0]] = data[i][1];
      }
    }
  }
  
  // הגדרות ברירת מחדל אם הגיליון ריק
  if (Object.keys(settings).length === 0) {
    return ContentService.createTextOutput(JSON.stringify({
      settings: {
        availabilityOpen: false,
        availabilityDay: 0,
        availabilityHour: '08:00'
      }
    }));
  }
  
  return ContentService.createTextOutput(JSON.stringify({settings: settings}));
}
